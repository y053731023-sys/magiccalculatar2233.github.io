<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Calculator</title>
    
    <!-- 引入必要的函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- 全局樣式設定 --- */
        body {
            background-color: #000;
            color: white;
            overflow: hidden; /* 禁止滾動 */
            touch-action: none; /* 禁止預設觸控行為 (如下拉重整) */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            /* 預設背景全黑 (手機) */
            background: #000;
        }
        
        /* 桌面版背景增加質感漸層 */
        @media (min-width: 640px) {
            body {
                background: radial-gradient(circle at 50% 120%, #1a1a1a, #000);
            }
        }

        /* 隱藏 Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* iOS 風格的彈簧動畫曲線 */
        .ease-ios { transition-timing-function: cubic-bezier(0.32, 0.72, 0, 1); }
        
        /* 按鈕按壓效果 */
        .btn-press:active { 
            transform: scale(0.92); 
            filter: brightness(1.2); 
        }
        
        /* 磨砂玻璃特效相容性 */
        .backdrop-blur-xl { 
            -webkit-backdrop-filter: blur(24px); 
            backdrop-filter: blur(24px); 
        }
        
        /* 處理 iPhone 底部橫條的安全區域 */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SVG 圖示組件 ---
        
        // 左上角時鐘圖示
        const ClockIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        // 右上角計算機圖示 (網格風格)
        const CalculatorIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
               <path fillRule="evenodd" d="M18 2H6C3.79 2 2 3.79 2 6V18C2 20.21 3.79 22 6 22H18C20.21 22 22 20.21 22 18V6C22 3.79 20.21 2 18 2ZM6 4H18C19.1 4 20 4.9 20 6V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V6C4 4.9 4.9 4 6 4ZM7 11H9V13H7V11ZM11 11H13V13H11V11ZM15 11H17V13H15V11ZM7 15H9V17H7V15ZM11 15H13V17H11V15ZM15 15H17V17H15V15ZM7 6V9H17V6H7Z" clipRule="evenodd"/>
            </svg>
        );

        // 倒退刪除鍵圖示
        const DeleteIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 5H9l-8 7 8 7h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"/>
                <line x1="18" y1="9" x2="12" y2="15"/>
                <line x1="12" y1="9" x2="18" y2="15"/>
            </svg>
        );

        // 關閉圖示
        const XIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // 設定圖示 (Debug用)
        const SettingsIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        );

        const MagicCalculator = () => {
            // --- 應用程式狀態 ---
            const [inputExpression, setInputExpression] = useState('0'); // 當前輸入
            const [lastExpression, setLastExpression] = useState(''); // 右上角小字 (上一步驟)
            const [isResultState, setIsResultState] = useState(false); // 是否剛顯示結果
            
            const [history, setHistory] = useState([]); // 歷史紀錄
            const [isHistoryOpen, setIsHistoryOpen] = useState(false); // 歷史面板開關

            // --- 魔術狀態 ---
            const [isMagicMode, setIsMagicMode] = useState(false);
            const [magicRemainder, setMagicRemainder] = useState('');
            const [magicIndex, setMagicIndex] = useState(0);
            const [debugMode, setDebugMode] = useState(false);

            // 取得目標數字 (當下時間)
            const getTargetNumber = () => {
                const now = new Date();
                const month = String(now.getMonth() + 1);
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                return parseInt(`${month}${day}${hours}${min}`);
            };

            // 格式化顯示 (加逗號，替換運算符)
            const formatDisplay = (expr) => {
                if (!expr) return '';
                let visualStr = expr
                .replace(/\*/g, '×') 
                .replace(/\//g, '÷')
                .replace(/\+/g, '+')
                .replace(/\-/g, '−');
                
                return visualStr.replace(/(\d+)(\.\d+)?/g, (match, p1, p2) => {
                    return Number(p1).toLocaleString('en-US') + (p2 || '');
                });
            };

            // 安全計算
            const safeCalculate = (expr) => {
                try {
                    const sanitized = expr.replace(/[^0-9+\-*/.]/g, '');
                    // eslint-disable-next-line no-new-func
                    const result = new Function('return ' + sanitized)();
                    return parseFloat(result.toFixed(10)); 
                } catch (e) {
                    return 'Error';
                }
            };

            // 動態字體大小 (符合圖片的大字體比例)
            const getFontSizeClass = (str) => {
                const len = str.length;
                // Desktop(sm): 使用圖片中那種大而飽滿的字體
                if (len > 18) return 'text-[2rem] sm:text-[2.5rem]';
                if (len > 14) return 'text-[2.5rem] sm:text-[3rem]';
                if (len > 11) return 'text-[3rem] sm:text-[3.8rem]';
                if (len > 9) return 'text-[3.8rem] sm:text-[4.5rem]';
                if (len > 7) return 'text-[4.5rem] sm:text-[5rem]';
                return 'text-[5rem] sm:text-[5.5rem]';
            };

            // --- 輸入處理 ---
            const handleNumPress = (num) => {
                if (isResultState) {
                    handleNewInput(num, true);
                    return;
                }
                if (isMagicMode) {
                    if (magicIndex < magicRemainder.length) {
                        const ghostChar = magicRemainder[magicIndex];
                        if (inputExpression === '0') {
                            setInputExpression(ghostChar);
                        } else {
                            setInputExpression(prev => prev + ghostChar);
                        }
                        setMagicIndex(prev => prev + 1);
                    }
                    return;
                }
                handleNewInput(num, false);
            };

            const handleNewInput = (num, reset) => {
                const val = String(num);
                if (reset) {
                    setLastExpression('');
                    setInputExpression(val === '.' ? '0.' : val);
                    setIsResultState(false);
                    return;
                }
                if (inputExpression === '0' && val !== '.') {
                    setInputExpression(val);
                } else {
                    if (val === '.') {
                        const parts = inputExpression.split(/[\+\-\*\/]/);
                        const currentNum = parts[parts.length - 1];
                        if (currentNum.includes('.')) return;
                    }
                    setInputExpression(prev => prev + val);
                }
            };

            const handleOperator = (op) => {
                setIsResultState(false);
                setLastExpression('');
                const lastChar = inputExpression.slice(-1);
                const isLastOp = ['+', '-', '*', '/'].includes(lastChar);
                if (isLastOp) {
                    setInputExpression(prev => prev.slice(0, -1) + op);
                } else {
                    if (inputExpression === 'Error') {
                        setInputExpression('0');
                    } else {
                        setInputExpression(prev => prev + op);
                    }
                }
            };

            const handleEqual = () => {
                if (isResultState) return;
                let finalResult;
                let finalExpression = inputExpression;
                
                if (isMagicMode) {
                    finalResult = getTargetNumber();
                    setIsMagicMode(false);
                    setMagicRemainder('');
                } else {
                    finalResult = safeCalculate(inputExpression);
                }

                setLastExpression(formatDisplay(finalExpression) + ' =');
                setInputExpression(String(finalResult));
                setIsResultState(true);
                
                const historyItem = {
                    expression: formatDisplay(finalExpression),
                    result: Number(finalResult).toLocaleString('en-US'),
                    rawResult: String(finalResult)
                };
                setHistory(prev => [historyItem, ...prev]);
            };

            const handleClear = () => {
                setInputExpression('0');
                setLastExpression('');
                setIsResultState(false);
                if (isMagicMode) setMagicIndex(0);
            };

            const handleBackspace = () => {
                if (isResultState) {
                    setLastExpression('');
                    setInputExpression('0');
                    setIsResultState(false);
                    return;
                }
                if (inputExpression.length > 1) {
                    setInputExpression(prev => prev.slice(0, -1));
                } else {
                    setInputExpression('0');
                }
            };
            
            const handleToggleSign = () => {
                const parts = inputExpression.split(/([\+\-\*\/])/);
                const lastToken = parts[parts.length - 1];
                if (lastToken && !isNaN(lastToken)) {
                     const newVal = parseFloat(lastToken) * -1;
                     parts[parts.length - 1] = newVal.toString();
                     setInputExpression(parts.join(''));
                }
            };
            
            const handlePercent = () => {
                const parts = inputExpression.split(/([\+\-\*\/])/);
                const lastToken = parts[parts.length - 1];
                if (lastToken && !isNaN(lastToken)) {
                     const newVal = parseFloat(lastToken) / 100;
                     parts[parts.length - 1] = newVal.toString();
                     setInputExpression(parts.join(''));
                }
            };

            // 魔術觸發邏輯 (點擊右上角計算機圖示)
            const toggleMagicMode = () => {
                if (isMagicMode) {
                    setIsMagicMode(false);
                    return;
                }
                const target = getTargetNumber();
                let currentExpr = inputExpression;
                if (['+', '-', '*', '/'].includes(currentExpr.slice(-1))) {
                    currentExpr = currentExpr.slice(0, -1);
                }
                const currentVal = safeCalculate(currentExpr);
                if (currentVal === 'Error') return;
                let remainder = target - currentVal;
                if (remainder < 0) remainder = 999999; 
                setMagicRemainder(String(remainder));
                setMagicIndex(0);
                setIsMagicMode(true);
                setIsResultState(false);
            };

            const loadHistory = (val) => {
                setInputExpression(val);
                setLastExpression('');
                setIsResultState(true);
                setIsHistoryOpen(false);
            };

            // 按鈕組件
            const Button = ({ text, icon, type, onClick }) => {
                const bgColors = {
                    func: 'bg-[#5c5c5e] text-white border border-white/10',
                    num: 'bg-[#333333] text-white border border-white/10',
                    orange: 'bg-[#ff9f0a] text-white border border-transparent',
                };
                
                let btnColor = bgColors.num;
                // 字體大小設定
                let fontSize = 'text-[2.5rem]'; 
                if (type === 'func') {
                    btnColor = bgColors.func;
                    fontSize = 'text-[2rem]';
                }
                if (type === 'op') {
                    btnColor = bgColors.orange;
                    fontSize = 'text-[2.75rem]';
                }

                let isActiveOp = false;
                if (type === 'op' && !isResultState) {
                    const lastChar = inputExpression.slice(-1);
                    const opMap = { '÷': '/', '×': '*', '−': '-', '+': '+' };
                    if (opMap[text] === lastChar) isActiveOp = true;
                }

                return (
                <button 
                    onClick={onClick} 
                    className={`
                        w-full aspect-square justify-center rounded-full
                        ${isActiveOp ? 'bg-white text-[#ff9f0a]' : btnColor}
                        ${fontSize} font-medium leading-none flex items-center select-none btn-press transition-colors duration-200
                    `}
                    style={{ WebkitTapHighlightColor: 'transparent' }}
                >
                    {icon ? icon : text}
                </button>
                );
            };

            return (
                <div className="flex justify-center items-center h-[100dvh] w-full font-sans overflow-hidden relative">
                    
                    {/* 主容器：限制為 iPhone 13 比例 (390x844)，桌面版有圓角陰影，手機版滿版 */}
                    <div className="relative w-full h-full sm:w-[390px] sm:h-[844px] sm:bg-black sm:rounded-[48px] sm:border-[10px] sm:border-[#1c1c1e] sm:shadow-2xl flex flex-col overflow-hidden z-10 transition-all duration-300">
                        
                        {/* 頂部圖示區 (歷史紀錄 & 計算機Icon) - 增加了上邊距來取代原本的狀態列空間 */}
                        <div className="flex justify-between px-6 pt-8 z-40">
                             <button 
                                onClick={() => setIsHistoryOpen(true)}
                                className="w-9 h-9 rounded-full flex items-center justify-center border border-white/40 text-white"
                             >
                                <ClockIcon className="w-5 h-5" />
                             </button>
                             
                             {/* 這裡現在是魔術觸發點 */}
                             <div 
                                className="w-9 h-9 rounded-full flex items-center justify-center border border-white/40 text-white cursor-pointer active:opacity-50"
                                onClick={toggleMagicMode}
                             >
                                <CalculatorIcon className="w-5 h-5" />
                             </div>
                        </div>

                        {/* 歷史紀錄面板 (Slide Up) */}
                        <div className={`absolute inset-0 z-50 transition-transform duration-500 ease-ios flex flex-col justify-end ${isHistoryOpen ? 'translate-y-0' : 'translate-y-full'}`}>
                            <div className="flex-1" onClick={() => setIsHistoryOpen(false)}></div>
                            <div className="h-[80%] bg-[#1c1c1e]/90 backdrop-blur-xl rounded-t-[30px] flex flex-col p-6 shadow-2xl border-t border-white/5 relative">
                                <div className="absolute top-3 left-1/2 -translate-x-1/2 w-10 h-1 bg-white/20 rounded-full"></div>
                                <div className="flex justify-between items-center mb-6 mt-4 pb-4 border-b border-white/10">
                                    <h3 className="text-white text-xl font-medium tracking-tight">History</h3>
                                    <button onClick={() => setIsHistoryOpen(false)} className="bg-[#3a3a3c] rounded-full p-1.5 text-gray-300 hover:bg-[#48484a] transition-colors">
                                        <XIcon className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar pb-6">
                                    {history.map((item, idx) => (
                                        <div key={idx} onClick={() => loadHistory(item.rawResult)} className="text-right p-4 rounded-2xl active:bg-white/10 cursor-pointer transition-colors border border-transparent hover:border-white/5">
                                            <div className="text-[#ff9f0a] text-lg mb-1 opacity-90">{item.expression} =</div>
                                            <div className="text-white text-4xl font-light tracking-tight">{item.result}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 螢幕顯示區 */}
                        <div className="flex-1 flex flex-col justify-end items-end px-6 sm:px-8 pb-8 gap-0 relative z-10 pointer-events-none">
                            {/* 右上角計算過程小字 */}
                            <div className={`text-[#8e8e93] text-[1.4rem] sm:text-[1.8rem] font-light tracking-wide transition-all duration-300 min-h-[36px] transform origin-right ${lastExpression ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                {lastExpression}
                            </div>
                            {/* 主數字 */}
                            <div className={`text-white font-bold leading-none transition-all duration-200 ${getFontSizeClass(formatDisplay(inputExpression))}`}>
                                {formatDisplay(inputExpression)}
                            </div>
                        </div>

                        {/* 鍵盤區域 */}
                        <div className="px-5 sm:px-6 pb-8 sm:pb-12 safe-pb">
                            <div className="grid grid-cols-4 gap-3 sm:gap-4">
                                {/* Row 1 */}
                                <Button icon={<DeleteIcon className="w-8 h-8 sm:w-10 sm:h-10" />} type="func" onClick={handleBackspace} />
                                <Button text="C" type="func" onClick={handleClear} />
                                <Button text="%" type="func" onClick={handlePercent} />
                                <Button text="÷" type="op" onClick={() => handleOperator('/')} />

                                {/* Row 2 */}
                                <Button text="7" type="num" onClick={() => handleNumPress(7)} />
                                <Button text="8" type="num" onClick={() => handleNumPress(8)} />
                                <Button text="9" type="num" onClick={() => handleNumPress(9)} />
                                <Button text="×" type="op" onClick={() => handleOperator('*')} />

                                {/* Row 3 */}
                                <Button text="4" type="num" onClick={() => handleNumPress(4)} />
                                <Button text="5" type="num" onClick={() => handleNumPress(5)} />
                                <Button text="6" type="num" onClick={() => handleNumPress(6)} />
                                <Button text="−" type="op" onClick={() => handleOperator('-')} />

                                {/* Row 4 */}
                                <Button text="1" type="num" onClick={() => handleNumPress(1)} />
                                <Button text="2" type="num" onClick={() => handleNumPress(2)} />
                                <Button text="3" type="num" onClick={() => handleNumPress(3)} />
                                <Button text="+" type="op" onClick={() => handleOperator('+')} />

                                {/* Row 5 */}
                                <Button icon={<span className="text-3xl sm:text-4xl pb-1">±</span>} type="func" onClick={handleToggleSign} />
                                <Button text="0" type="num" onClick={() => handleNumPress(0)} />
                                <Button text="." type="num" onClick={() => handleNewInput('.', false)} />
                                <Button text="=" type="op" onClick={handleEqual} />
                            </div>
                        </div>

                        {/* 隱藏式 Debug 按鈕 (右下角) */}
                        <div className="absolute bottom-4 right-4 z-50 safe-pb">
                            <button onClick={() => setDebugMode(!debugMode)} className="w-8 h-8 rounded-full flex items-center justify-center text-white/5 hover:text-white/20 transition-colors">
                                <SettingsIcon className="w-4 h-4" />
                            </button>
                        </div>

                        {/* Debug 面板 */}
                        {debugMode && (
                            <div className="absolute bottom-16 right-4 bg-[#1c1c1e]/90 backdrop-blur-md text-white p-4 rounded-xl text-xs font-mono border border-white/10 w-48 shadow-2xl z-50">
                                <div className="font-bold border-b border-white/10 pb-2 mb-2 flex justify-between">
                                    <span>Magic Debug</span>
                                    <span className={`px-1.5 rounded ${isMagicMode ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"}`}>{isMagicMode ? "ON" : "OFF"}</span>
                                </div>
                                <div className="space-y-1 opacity-80">
                                    <div>Target: <span className="text-blue-400">{getTargetNumber()}</span></div>
                                    {isMagicMode && (
                                        <div className="mt-2 bg-yellow-500/10 p-2 rounded text-yellow-500 border border-yellow-500/20">
                                            Ghost: {magicRemainder}<br/>
                                            Next: <span className="font-bold text-lg">{magicRemainder[magicIndex]}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MagicCalculator />);
    </script>
</body>
</html>
