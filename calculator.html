<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="format-detection" content="telephone=no">
    <title>Calculator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #000;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .ease-ios { transition-timing-function: cubic-bezier(0.32, 0.72, 0, 1); }
        
        .btn-press { transition: filter 0.1s, transform 0.05s; }
        .btn-num-press:active { filter: brightness(1.6); }
        .btn-func-press:active { filter: brightness(0.7); }
        .btn-op-press:active { filter: brightness(0.8); opacity: 0.8; }

        .backdrop-blur-xl { 
            -webkit-backdrop-filter: blur(24px); 
            backdrop-filter: blur(24px); 
        }
        
        * { -webkit-tap-highlight-color: transparent; }

        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom, 34px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const ClockIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const CalculatorIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" d="M18 2H6C3.79 2 2 3.79 2 6V18C2 20.21 3.79 22 6 22H18C20.21 22 22 20.21 22 18V6C22 3.79 20.21 2 18 2ZM6 4H18C19.1 4 20 4.9 20 6V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V6C4 4.9 4.9 4 6 4Z" clipRule="evenodd" opacity="0.3"/>
                <rect x="6" y="6" width="12" height="3" rx="0.5" fill="currentColor" />
                <rect x="6" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="10.5" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="15" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="6" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="10.5" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="15" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
            </svg>
        );

        const PlusMinusIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 5v6m-3-3h6" />
                <path d="M9 17h6" />
            </svg>
        );

        const DeleteIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 5H9l-8 7 8 7h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"/>
                <line x1="18" y1="9" x2="12" y2="15"/>
                <line x1="12" y1="9" x2="18" y2="15"/>
            </svg>
        );

        const XIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        const SettingsIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        );

        const MagicCalculator = () => {
            const [inputExpression, setInputExpression] = useState('0');
            const [lastExpression, setLastExpression] = useState('');
            const [isResultState, setIsResultState] = useState(false);
            const [activeOp, setActiveOp] = useState(null); 
            
            const [history, setHistory] = useState([]);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);

            // Magic State
            const [isMagicMode, setIsMagicMode] = useState(false);
            const [magicRemainder, setMagicRemainder] = useState('');
            const [magicIndex, setMagicIndex] = useState(0);
            const [debugMode, setDebugMode] = useState(false);

            const triggerHaptic = () => {
                if (navigator.vibrate) navigator.vibrate(10);
            };

            const getTargetNumber = () => {
                const now = new Date();
                const month = String(now.getMonth() + 1);
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                return parseInt(`${month}${day}${hours}${min}`);
            };

            const formatDisplay = (expr) => {
                if (!expr) return '';
                let visualStr = expr
                .replace(/\*/g, '×') 
                .replace(/\//g, '÷')
                .replace(/\+/g, '+')
                .replace(/\-/g, '−');
                
                return visualStr.replace(/(\d+)(\.\d+)?/g, (match, p1, p2) => {
                    return Number(p1).toLocaleString('en-US') + (p2 || '');
                });
            };

            const safeCalculate = (expr) => {
                try {
                    const sanitized = expr.replace(/[^0-9+\-*/.]/g, '');
                    const result = new Function('return ' + sanitized)();
                    return parseFloat(Number(result).toPrecision(12)); 
                } catch (e) {
                    return 'Error';
                }
            };

            const getFontSizeClass = (str) => {
                const len = str.length;
                if (len > 9) return 'text-[2.8rem]';
                if (len > 8) return 'text-[3.2rem]';
                if (len > 7) return 'text-[3.8rem]';
                if (len > 6) return 'text-[4.5rem]';
                return 'text-[5.5rem]'; 
            };

            // Logic
            const handleNumPress = (num) => {
                triggerHaptic();
                setActiveOp(null);
                if (isResultState) {
                    handleNewInput(num, true);
                    return;
                }
                if (isMagicMode) {
                    // 魔術模式：優先輸入鬼影數字
                    if (magicIndex < magicRemainder.length) {
                        const ghostChar = magicRemainder[magicIndex];
                        if (inputExpression === '0') {
                            setInputExpression(ghostChar);
                        } else {
                            setInputExpression(prev => prev + ghostChar);
                        }
                        setMagicIndex(prev => prev + 1);
                        return;
                    }
                    // 如果鬼影數字用完了 (Overflow)，自動切換回正常輸入
                    // 這樣螢幕會顯示真實按下的數字，避免卡住
                }
                handleNewInput(num, false);
            };

            const handleNewInput = (num, reset) => {
                const val = String(num);
                if (reset) {
                    setLastExpression('');
                    setInputExpression(val === '.' ? '0.' : val);
                    setIsResultState(false);
                    return;
                }
                if (inputExpression === '0' && val !== '.') {
                    setInputExpression(val);
                } else {
                    if (val === '.') {
                        const parts = inputExpression.split(/[\+\-\*\/]/);
                        const currentNum = parts[parts.length - 1];
                        if (currentNum.includes('.')) return;
                    }
                    setInputExpression(prev => prev + val);
                }
            };

            const handleOperator = (op) => {
                triggerHaptic();
                setIsResultState(false);
                setLastExpression('');
                setActiveOp(op);
                
                const lastChar = inputExpression.slice(-1);
                const isLastOp = ['+', '-', '*', '/'].includes(lastChar);
                if (isLastOp) {
                    setInputExpression(prev => prev.slice(0, -1) + op);
                } else {
                    if (inputExpression === 'Error') {
                        setInputExpression('0');
                    } else {
                        setInputExpression(prev => prev + op);
                    }
                }
            };

            const handleEqual = () => {
                triggerHaptic();
                if (isResultState) return;
                setActiveOp(null);
                
                let finalResult;
                
                // 邏輯優化：
                // 不管是否在魔術模式，我們都計算螢幕上「當前顯示」的算式結果。
                // 1. 正常魔術：鬼影數字正確輸入 -> 算式結果 = 目標時間。
                // 2. 失誤溢出：鬼影數字 + 多按的真實數字 -> 算式結果 = 真實數學結果。
                // 這樣可以確保計算機永遠「誠實」，不會因為多按了一位數而顯示不合理的答案。
                finalResult = safeCalculate(inputExpression);

                if (isMagicMode) {
                    setIsMagicMode(false);
                    setMagicRemainder('');
                }

                setLastExpression(formatDisplay(inputExpression) + ' =');
                setInputExpression(String(finalResult));
                setIsResultState(true);
                
                const historyItem = {
                    expression: formatDisplay(inputExpression),
                    result: Number(finalResult).toLocaleString('en-US'),
                    rawResult: String(finalResult)
                };
                setHistory(prev => [historyItem, ...prev]);
            };

            const handleClear = () => {
                triggerHaptic();
                setActiveOp(null);
                if (inputExpression !== '0' || lastExpression !== '') {
                    setInputExpression('0');
                    setLastExpression('');
                    setIsResultState(false);
                    if (isMagicMode) setMagicIndex(0);
                }
            };

            const handleToggleSign = () => {
                triggerHaptic();
                if (!isResultState && inputExpression !== '0') {
                     if (!isNaN(inputExpression)) {
                         setInputExpression(String(parseFloat(inputExpression) * -1));
                     }
                }
            };
            
            const handlePercent = () => {
                triggerHaptic();
                if (!isNaN(inputExpression)) {
                     setInputExpression(String(parseFloat(inputExpression) / 100));
                }
            };

            const handleBackspace = () => {
                triggerHaptic();
                if (isResultState) {
                    setLastExpression('');
                    setInputExpression('0');
                    setIsResultState(false);
                    return;
                }
                if (inputExpression.length > 1) {
                    setInputExpression(prev => prev.slice(0, -1));
                } else {
                    setInputExpression('0');
                }
            };

            // 魔術觸發邏輯
            const toggleMagicMode = () => {
                triggerHaptic();
                if (isMagicMode) {
                    setIsMagicMode(false);
                    return;
                }
                const target = getTargetNumber();
                let currentExpr = inputExpression;
                if (['+', '-', '*', '/'].includes(currentExpr.slice(-1))) {
                    currentExpr = currentExpr.slice(0, -1);
                }
                
                const currentVal = safeCalculate(currentExpr);
                if (currentVal === 'Error') return;
                
                // 反推需要的數字 (預設用減法)
                let remainder = target - currentVal;
                if (remainder < 0) remainder = 999999; 
                
                setMagicRemainder(String(remainder));
                setMagicIndex(0);
                setIsMagicMode(true);
                setIsResultState(false);
            };

            const loadHistory = (val) => {
                triggerHaptic();
                setInputExpression(val);
                setLastExpression('');
                setIsResultState(true);
                setIsHistoryOpen(false);
            };

            const Button = ({ text, icon, type, onClick, opValue, wide }) => {
                const bgColors = {
                    func: 'bg-[#A5A5A5] text-black', 
                    num: 'bg-[#333333] text-white',   
                    orange: 'bg-[#FF9F0A] text-white',
                };
                
                let btnColor = bgColors.num;
                let fontSize = 'text-[2.6rem]'; 
                let pressEffect = 'btn-num-press';

                if (type === 'func') {
                    btnColor = bgColors.func;
                    fontSize = 'text-[2.2rem]';
                    pressEffect = 'btn-func-press';
                }
                if (type === 'op') {
                    btnColor = bgColors.orange;
                    fontSize = 'text-[3rem]'; 
                    pressEffect = 'btn-op-press';
                    if (activeOp && activeOp === opValue) {
                        btnColor = 'bg-white text-[#FF9F0A]';
                        pressEffect = '';
                    }
                }

                return (
                <button 
                    onClick={onClick} 
                    className={`
                        ${wide ? 'col-span-2 w-auto pl-[34px] text-left items-center justify-start rounded-[44px]' : 'w-full aspect-square justify-center rounded-full'}
                        ${btnColor}
                        ${fontSize} font-light leading-none flex items-center select-none btn-press ${pressEffect} transition-all duration-100
                    `}
                    style={{ WebkitTapHighlightColor: 'transparent' }}
                >
                    {icon ? icon : text}
                </button>
                );
            };

            const clearBtnText = (inputExpression === '0' && lastExpression === '') ? 'AC' : 'C';

            return (
                <div className="flex justify-center items-center h-[100dvh] w-full font-sans overflow-hidden relative bg-black">
                    
                    <div className="relative w-full h-full sm:w-[390px] sm:h-[844px] sm:bg-black sm:rounded-[48px] sm:border-[10px] sm:border-[#1c1c1e] sm:shadow-2xl flex flex-col overflow-hidden z-10 transition-all duration-300">
                        
                        {/* 頂部圖示區 */}
                        <div className="flex justify-between px-6 pt-12 z-40">
                             <button 
                                onClick={() => setIsHistoryOpen(true)}
                                className="w-10 h-10 rounded-full flex items-center justify-center border border-white/30 text-white hover:bg-white/10 transition-colors"
                             >
                                <ClockIcon className="w-6 h-6" />
                             </button>
                             
                             {/* 觸發開關：點擊右側小鍵盤 (包含狀態指示燈) */}
                             <div 
                                className="w-10 h-10 rounded-full flex items-center justify-center border border-white/30 text-white cursor-pointer active:opacity-50 transition-opacity relative"
                                onClick={toggleMagicMode}
                             >
                                <CalculatorIcon className="w-6 h-6" />
                                {/* 魔術狀態指示燈：極小的紅點，僅供表演者確認 */}
                                {isMagicMode && (
                                    <div className="absolute top-0 right-0 w-1.5 h-1.5 bg-red-600 rounded-full shadow-sm"></div>
                                )}
                             </div>
                        </div>

                        {/* 歷史紀錄面板 */}
                        <div className={`absolute inset-0 z-50 transition-transform duration-500 ease-ios flex flex-col justify-end ${isHistoryOpen ? 'translate-y-0' : 'translate-y-full'}`}>
                            <div className="flex-1" onClick={() => setIsHistoryOpen(false)}></div>
                            <div className="h-[80%] bg-[#1c1c1e]/95 backdrop-blur-xl rounded-t-[30px] flex flex-col p-6 shadow-2xl border-t border-white/5 relative">
                                <div className="absolute top-3 left-1/2 -translate-x-1/2 w-10 h-1 bg-white/20 rounded-full"></div>
                                <div className="flex justify-between items-center mb-6 mt-4 pb-4 border-b border-white/10">
                                    <h3 className="text-white text-xl font-medium tracking-tight">History</h3>
                                    <button onClick={() => setIsHistoryOpen(false)} className="bg-[#3a3a3c] rounded-full p-1.5 text-gray-300 hover:bg-[#48484a] transition-colors">
                                        <XIcon className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar pb-6">
                                    {history.map((item, idx) => (
                                        <div key={idx} onClick={() => loadHistory(item.rawResult)} className="text-right p-4 rounded-2xl active:bg-white/10 cursor-pointer transition-colors border border-transparent hover:border-white/5">
                                            <div className="text-[#ff9f0a] text-lg mb-1 opacity-90">{item.expression} =</div>
                                            <div className="text-white text-4xl font-light tracking-tight">{item.result}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 螢幕顯示區 */}
                        <div className="flex-1 flex flex-col justify-end items-end px-9 pb-6 gap-0 relative z-10 pointer-events-none">
                            <div className={`text-[#8e8e93] text-[1.5rem] font-light tracking-wide transition-all duration-300 min-h-[30px] transform origin-right ${lastExpression ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                {lastExpression}
                            </div>
                            <div className={`text-white font-light leading-none transition-all duration-200 tracking-tight ${getFontSizeClass(formatDisplay(inputExpression))}`}>
                                {formatDisplay(inputExpression)}
                            </div>
                        </div>

                        {/* 鍵盤區域 */}
                        <div className="px-4 pb-[env(safe-area-inset-bottom,34px)] mb-2">
                            <div className="grid grid-cols-4 gap-[14px]">
                                {/* Row 1: Backspace | AC | % | ÷ */}
                                <Button icon={<DeleteIcon className="w-8 h-8" />} type="func" onClick={handleBackspace} />
                                <Button text={clearBtnText} type="func" onClick={handleClear} />
                                <Button text="%" type="func" onClick={handlePercent} />
                                <Button text="÷" type="op" opValue="/" onClick={() => handleOperator('/')} />

                                {/* Row 2 */}
                                <Button text="7" type="num" onClick={() => handleNumPress(7)} />
                                <Button text="8" type="num" onClick={() => handleNumPress(8)} />
                                <Button text="9" type="num" onClick={() => handleNumPress(9)} />
                                <Button text="×" type="op" opValue="*" onClick={() => handleOperator('*')} />

                                {/* Row 3 */}
                                <Button text="4" type="num" onClick={() => handleNumPress(4)} />
                                <Button text="5" type="num" onClick={() => handleNumPress(5)} />
                                <Button text="6" type="num" onClick={() => handleNumPress(6)} />
                                <Button text="−" type="op" opValue="-" onClick={() => handleOperator('-')} />

                                {/* Row 4 */}
                                <Button text="1" type="num" onClick={() => handleNumPress(1)} />
                                <Button text="2" type="num" onClick={() => handleNumPress(2)} />
                                <Button text="3" type="num" onClick={() => handleNumPress(3)} />
                                <Button text="+" type="op" opValue="+" onClick={() => handleOperator('+')} />

                                {/* Row 5: +/- | 0 | . | = */}
                                <Button icon={<PlusMinusIcon className="w-8 h-8 text-white" />} type="num" onClick={handleToggleSign} />
                                <Button text="0" type="num" onClick={() => handleNumPress(0)} />
                                <Button text="." type="num" onClick={() => handleNewInput('.', false)} />
                                <Button text="=" type="op" onClick={handleEqual} />
                            </div>
                        </div>

                        {/* 隱藏式 Debug 按鈕 (右下角) */}
                        <div className="absolute bottom-4 right-4 z-50 safe-pb opacity-0 hover:opacity-100 transition-opacity">
                            <button onClick={() => setDebugMode(!debugMode)} className="w-10 h-10 rounded-full flex items-center justify-center">
                            </button>
                        </div>

                        {/* Debug 面板 */}
                        {debugMode && (
                            <div className="absolute top-20 left-6 bg-white/90 backdrop-blur-md text-black p-4 rounded-xl text-xs font-mono border w-48 shadow-2xl z-50">
                                <div className="font-bold border-b pb-2 mb-2 flex justify-between">
                                    <span>Magic Status</span>
                                    <span className={isMagicMode ? "text-green-600" : "text-red-600"}>{isMagicMode ? "ON" : "OFF"}</span>
                                </div>
                                <div>Target: {getTargetNumber()}</div>
                                {isMagicMode && <div>Ghost: {magicRemainder}</div>}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MagicCalculator />);
    </script>
</body>
</html>
